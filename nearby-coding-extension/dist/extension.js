(()=>{"use strict";var e={52:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.GrowthSystem=void 0;const n=s(377);class a{constructor(e=[],t=[]){this.encounters=[],this.logins=[],this.encounters=e,this.logins=t}processLogin(e){const t=(0,n.getTodayString)();return this.logins.some(s=>s.userId===e.id&&s.date===t)?{xpGained:0,levelUp:!1,newLevel:e.level,unlockedAvatars:[]}:(this.logins.push({userId:e.id,timestamp:Date.now(),date:t}),this.addXP(e,10,"login"))}processEncounter(e,t){const s=(0,n.getTodayString)();return this.encounters.some(n=>n.userId===e.id&&n.otherUserId===t&&n.date===s)?{xpGained:0,levelUp:!1,newLevel:e.level,unlockedAvatars:[]}:(this.encounters.push({userId:e.id,otherUserId:t,date:s}),this.addXP(e,5,"encounter"))}addXP(e,t,s){const a=e.level,o=e.xp+t,i=(0,n.calculateLevel)(o),r=i>a;return{xpGained:t,levelUp:r,newLevel:i,unlockedAvatars:r?(0,n.getNewlyUnlockedAvatars)(a,i):[]}}getTodayEncounters(e){const t=(0,n.getTodayString)();return this.encounters.filter(s=>s.userId===e&&s.date===t).map(e=>e.otherUserId)}hasLoggedInToday(e){const t=(0,n.getTodayString)();return this.logins.some(s=>s.userId===e&&s.date===t)}getUserStats(e){const t=this.encounters.filter(t=>t.userId===e).length,s=this.getTodayEncounters(e).length,n=this.logins.filter(t=>t.userId===e).length,a=this.logins.filter(t=>t.userId===e).sort((e,t)=>t.timestamp-e.timestamp);let o=0,i=new Date;for(const e of a){const t=new Date(e.timestamp);if(Math.floor((i.getTime()-t.getTime())/864e5)!==o)break;o++,i=t}return{totalEncounters:t,todayEncounters:s,totalLogins:n,loginStreak:o}}serialize(){return{encounters:this.encounters,logins:this.logins}}static deserialize(e){return new a(e.encounters,e.logins)}}t.GrowthSystem=a},377:(e,t)=>{var s;Object.defineProperty(t,"__esModule",{value:!0}),t.isToday=t.getTodayString=t.getNewlyUnlockedAvatars=t.getUnlockedAvatars=t.calculateLevel=t.calculateRequiredXP=t.AVATAR_CONFIG=t.AvatarType=void 0,function(e){e.HUMAN="human",e.CAT="cat",e.ROBOT="robot",e.WIZARD="wizard",e.DRAGON="dragon",e.BUG="bug"}(s=t.AvatarType||(t.AvatarType={})),t.AVATAR_CONFIG={[s.HUMAN]:{emoji:"🧑‍💻",unlockLevel:1,name:"人"},[s.CAT]:{emoji:"🐱",unlockLevel:2,name:"猫"},[s.ROBOT]:{emoji:"🤖",unlockLevel:3,name:"ロボット"},[s.WIZARD]:{emoji:"🧙‍♂️",unlockLevel:5,name:"魔法使い"},[s.DRAGON]:{emoji:"🐉",unlockLevel:10,name:"ドラゴン"},[s.BUG]:{emoji:"🐛",unlockLevel:10,name:"バグ"}},t.calculateRequiredXP=e=>50*e*e,t.calculateLevel=e=>{let s=1;for(;(0,t.calculateRequiredXP)(s+1)<=e;)s++;return s},t.getUnlockedAvatars=e=>Object.entries(t.AVATAR_CONFIG).filter(([t,s])=>s.unlockLevel<=e).map(([e])=>e),t.getNewlyUnlockedAvatars=(e,s)=>{const n=(0,t.getUnlockedAvatars)(e);return(0,t.getUnlockedAvatars)(s).filter(e=>!n.includes(e))},t.getTodayString=()=>(new Date).toISOString().split("T")[0],t.isToday=e=>e===(0,t.getTodayString)()},398:e=>{e.exports=require("vscode")},733:function(e,t,s){var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s);var a=Object.getOwnPropertyDescriptor(t,s);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,n,a)}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),a=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return a(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.deactivate=t.activate=t.NearbyCodingViewProvider=void 0;const i=o(s(398)),r=s(52),c=s(377);class l{constructor(e){this._extensionContext=e,this._disposed=!1,this._lastSeenUsers=new Map,this._context=e,this._userId=this._context.globalState.get("nearbyCoding.userId")||this._generateUserId(),this._context.globalState.update("nearbyCoding.userId",this._userId);const t=this._context.globalState.get("nearbyCoding.growthData");this._growthSystem=t?r.GrowthSystem.deserialize(t):new r.GrowthSystem,this._appState=this._loadAppState()}_generateUserId(){return"user-"+Math.random().toString(36).substr(2,9)+"-"+Date.now().toString(36)}_loadAppState(){const e=this._context.globalState.get("nearbyCoding.user"),t=this._getConfiguration(),s={id:this._userId,name:t.name,message:t.message,avatar:t.avatar,avatarType:c.AvatarType.HUMAN,xp:0,level:1,lastLogin:"",lastSeen:0};return{currentScreen:e?"plaza":"setup",user:e?{...s,...e}:s,todayEncounters:new Set,hasLoggedInToday:this._growthSystem.hasLoggedInToday(this._userId)}}_saveAppState(){this._context.globalState.update("nearbyCoding.user",this._appState.user),this._context.globalState.update("nearbyCoding.growthData",this._growthSystem.serialize())}_handleSetupComplete(e){this._appState.user={...this._appState.user,name:e.name,message:e.message,avatarType:e.avatarType,avatar:c.AVATAR_CONFIG[e.avatarType].emoji},this._appState.currentScreen="plaza",this._saveAppState();const t=i.workspace.getConfiguration("nearbyCoding");t.update("name",e.name,i.ConfigurationTarget.Global),t.update("message",e.message,i.ConfigurationTarget.Global),t.update("avatar",c.AVATAR_CONFIG[e.avatarType].emoji,i.ConfigurationTarget.Global),this._processLogin(),this._sendAppStateToWebview()}_processLogin(){this._sendLogin()}_sendAppStateToWebview(){this._view&&this._view.webview.postMessage({command:"updateAppState",appState:this._appState})}resolveWebviewView(e,t,s){this._view=e,e.webview.options={enableScripts:!0,localResourceRoots:[this._extensionContext.extensionUri]},e.webview.html=this._getHtmlForWebview(e.webview),e.webview.onDidReceiveMessage(e=>{"setupComplete"===e.command&&this._handleSetupComplete(e.userData)},void 0,this._context.subscriptions),this._context.subscriptions.push(i.workspace.onDidChangeConfiguration(e=>{e.affectsConfiguration("nearbyCoding")&&(this._updateWebviewWithCurrentConfig(),this._restartLoops())})),this._sendAppStateToWebview(),"plaza"===this._appState.currentScreen&&this._processLogin(),this._startLoops(),e.onDidDispose(()=>{this._stopLoops()})}_getHtmlForWebview(e){const t=e.asWebviewUri(i.Uri.joinPath(this._extensionContext.extensionUri,"dist","webview.js")),s=function(){let e="";for(let t=0;t<32;t++)e+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*Math.random()));return e}();return`<!DOCTYPE html>\n<html lang="ja">\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; script-src 'nonce-${s}'; style-src ${e.cspSource} 'unsafe-inline'; connect-src https:;">\n    <title>Nearby Coding</title>\n</head>\n<body>\n    <div id="root"></div>\n    <script nonce="${s}" src="${t}"><\/script>\n</body>\n</html>`}_getConfiguration(){const e=i.workspace.getConfiguration("nearbyCoding");let t=e.get("serverUrl","https://nearby-coding-server-i3mbz1w0s-fujii-yoshinobus-projects.vercel.app");return t.endsWith("/api/nearby")||(t=t.replace(/\/$/,"")+"/api/nearby"),{serverUrl:t,name:e.get("name","Anonymous"),message:e.get("message","よろしく！"),avatar:e.get("avatar","🧑‍💻")}}async _sendLogin(){if(this._disposed)return;const e=this._getConfiguration();try{const t=await fetch(e.serverUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"login",id:this._userId,name:this._appState.user.name,message:this._appState.user.message,avatar:this._appState.user.avatar,avatarType:this._appState.user.avatarType})});if(t.ok){const e=await t.json();if(e.success){if(this._appState.user=e.user,this._saveAppState(),e.loginXP>0&&this._view?.webview.postMessage({command:"xpGained",eventType:"login",amount:e.loginXP,message:"出社！"}),e.levelUp&&this._view?.webview.postMessage({command:"levelUp",newLevel:e.newLevel,unlockedAvatars:[]}),e.encounters&&e.encounters.length>0)for(const t of e.encounters)this._view?.webview.postMessage({command:"xpGained",eventType:"encounter",amount:t.xpGained,message:`${t.user.name}と遭遇！`});this._view?.webview.postMessage({command:"updateUsers",users:e.todayUsers||[],newUsers:e.todayUsers||[]})}}else console.warn("Nearby Coding: Login failed",t.status)}catch(e){console.warn("Nearby Coding: Login error",e)}}async _fetchUsers(){if(this._disposed||!this._view)return;const e=this._getConfiguration().serverUrl.replace("/api/nearby","/api/users");try{const t=await fetch(e,{method:"GET"});if(t.ok){const e=await t.json();if(e.success&&e.users){const t=[],s=Date.now();e.users.forEach(e=>{if(e.id!==this._userId){const n=this._lastSeenUsers.get(e.id)||0;(!n||s-n>3e5)&&(t.push(e),this._processEncounter(e.id)),this._lastSeenUsers.set(e.id,s)}}),this._view.webview.postMessage({command:"updateUsers",users:e.users,newUsers:t})}}}catch(e){console.warn("Nearby Coding: Fetch users error",e)}}async _processEncounter(e){if(this._disposed)return;const t=this._getConfiguration();try{const s=await fetch(t.serverUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"encounter",id:this._userId,encounterUserId:e})});if(s.ok){const t=await s.json();t.success&&t.xpGained>0&&(this._appState.user=t.user,this._appState.todayEncounters.add(e),this._saveAppState(),this._view?.webview.postMessage({command:"xpGained",eventType:"encounter",amount:t.xpGained,message:"遭遇！"}),t.levelUp&&this._view?.webview.postMessage({command:"levelUp",newLevel:t.newLevel,unlockedAvatars:[]}))}}catch(e){console.warn("Nearby Coding: Encounter error",e)}}_startLoops(){this._stopLoops(),this._sendLogin(),this._postInterval=setInterval(()=>{this._sendLogin()},1e4),this._getInterval=setInterval(()=>{this._fetchUsers()},6e3),setTimeout(()=>{this._fetchUsers()},1e3)}_stopLoops(){this._postInterval&&(clearInterval(this._postInterval),this._postInterval=void 0),this._getInterval&&(clearInterval(this._getInterval),this._getInterval=void 0)}_updateWebviewWithCurrentConfig(){this._view&&this._sendAppStateToWebview()}_restartLoops(){this._stopLoops(),this._startLoops()}dispose(){this._disposed=!0,this._stopLoops()}}t.NearbyCodingViewProvider=l,l.viewType="nearbyCoding.plaza",t.activate=function(e){const t=new l(e);e.subscriptions.push(i.window.registerWebviewViewProvider(l.viewType,t,{webviewOptions:{retainContextWhenHidden:!0}}))},t.deactivate=function(){}}},t={},s=function s(n){var a=t[n];if(void 0!==a)return a.exports;var o=t[n]={exports:{}};return e[n].call(o.exports,o,o.exports,s),o.exports}(733);module.exports=s})();
//# sourceMappingURL=extension.js.map