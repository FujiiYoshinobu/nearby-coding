(()=>{"use strict";var e={398:e=>{e.exports=require("vscode")},733:function(e,t,s){var i=this&&this.__createBinding||(Object.create?function(e,t,s,i){void 0===i&&(i=s);var r=Object.getOwnPropertyDescriptor(t,s);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,i,r)}:function(e,t,s,i){void 0===i&&(i=s),e[i]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&i(t,e,s);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.deactivate=t.activate=t.NearbyCodingViewProvider=void 0;const o=n(s(398));class a{constructor(e){this._extensionContext=e,this._disposed=!1,this._lastSeenUsers=new Map,this._context=e,this._userId=this._context.globalState.get("nearbyCoding.userId")||this._generateUserId(),this._context.globalState.update("nearbyCoding.userId",this._userId)}_generateUserId(){return"user-"+Math.random().toString(36).substr(2,9)+"-"+Date.now().toString(36)}resolveWebviewView(e,t,s){this._view=e,e.webview.options={enableScripts:!0,localResourceRoots:[this._extensionContext.extensionUri]},e.webview.html=this._getHtmlForWebview(e.webview),this._context.subscriptions.push(o.workspace.onDidChangeConfiguration(e=>{e.affectsConfiguration("nearbyCoding")&&(this._updateWebviewWithCurrentConfig(),this._restartLoops())})),this._updateWebviewWithCurrentConfig(),this._startLoops(),e.onDidDispose(()=>{this._stopLoops()})}_getHtmlForWebview(e){const t=e.asWebviewUri(o.Uri.joinPath(this._extensionContext.extensionUri,"dist","webview.js")),s=function(){let e="";for(let t=0;t<32;t++)e+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*Math.random()));return e}();return`<!DOCTYPE html>\n<html lang="ja">\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; script-src 'nonce-${s}'; style-src ${e.cspSource} 'unsafe-inline'; connect-src https:;">\n    <title>Nearby Coding</title>\n</head>\n<body>\n    <div id="root"></div>\n    <script nonce="${s}" src="${t}"><\/script>\n</body>\n</html>`}_getConfiguration(){const e=o.workspace.getConfiguration("nearbyCoding");let t=e.get("serverUrl","https://nearby-coding-server-i3mbz1w0s-fujii-yoshinobus-projects.vercel.app");return t.endsWith("/api/nearby")||(t=t.replace(/\/$/,"")+"/api/nearby"),{serverUrl:t,name:e.get("name","Anonymous"),message:e.get("message","よろしく！"),avatar:e.get("avatar","🧑‍💻")}}async _sendPing(){if(this._disposed)return;const e=this._getConfiguration();try{const t=await fetch(e.serverUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:this._userId,name:e.name,message:e.message,avatar:e.avatar})});t.ok||console.warn("Nearby Coding: Ping failed",t.status)}catch(e){console.warn("Nearby Coding: Ping error",e)}}async _fetchUsers(){if(this._disposed||!this._view)return;const e=this._getConfiguration();try{const t=await fetch(e.serverUrl,{method:"GET"});if(t.ok){const s=await t.json(),i=[],r=Date.now();s.forEach(e=>{if(e.id!==this._userId){const t=this._lastSeenUsers.get(e.id)||0;(!t||r-t>3e5)&&i.push(e),this._lastSeenUsers.set(e.id,r)}}),this._view.webview.postMessage({command:"updateUsers",users:s,newUsers:i,selfId:this._userId,selfAvatar:e.avatar})}}catch(e){console.warn("Nearby Coding: Fetch users error",e)}}_startLoops(){this._stopLoops(),this._sendPing(),this._postInterval=setInterval(()=>{this._sendPing()},1e4),this._getInterval=setInterval(()=>{this._fetchUsers()},6e3),setTimeout(()=>{this._fetchUsers()},1e3)}_stopLoops(){this._postInterval&&(clearInterval(this._postInterval),this._postInterval=void 0),this._getInterval&&(clearInterval(this._getInterval),this._getInterval=void 0)}_updateWebviewWithCurrentConfig(){if(!this._view)return;const e=this._getConfiguration();this._view.webview.postMessage({command:"updateUsers",users:[],selfId:this._userId,selfAvatar:e.avatar})}_restartLoops(){this._stopLoops(),this._startLoops()}dispose(){this._disposed=!0,this._stopLoops()}}t.NearbyCodingViewProvider=a,a.viewType="nearbyCoding.plaza",t.activate=function(e){const t=new a(e);e.subscriptions.push(o.window.registerWebviewViewProvider(a.viewType,t,{webviewOptions:{retainContextWhenHidden:!0}}))},t.deactivate=function(){}}},t={},s=function s(i){var r=t[i];if(void 0!==r)return r.exports;var n=t[i]={exports:{}};return e[i].call(n.exports,n,n.exports,s),n.exports}(733);module.exports=s})();
//# sourceMappingURL=extension.js.map